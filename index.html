<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project OS - Ali Bazrafkan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        .page { display: none; }
        .active-page { display: block; }
        #mermaid-baseline svg, #mermaid-progress svg { 
            max-width: 100% !important; 
            height: auto !important;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }
        .mermaid .done { fill: #000000 !important; stroke: #000000 !important; }
        .mermaid .active { fill: #3b82f6 !important; stroke: #2563eb !important; }
        .mermaid text { font-weight: 800 !important; font-family: 'Inter', sans-serif !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-xl flex justify-between items-center border-b-4 border-blue-600">
        <div class="flex flex-col">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-1 px-2 rounded font-black text-[10px] italic">OS</div>
                <h1 id="nav-title" class="font-black tracking-tighter uppercase text-sm">Project Control</h1>
            </div>
            <span class="text-[9px] text-slate-400 font-bold tracking-widest mt-1 uppercase">Developed by Ali Bazrafkan</span>
        </div>
        <div class="flex gap-4 text-[10px] font-bold uppercase tracking-widest">
            <button onclick="showPage('setup')" class="hover:text-blue-400">1. Setup</button>
            <button onclick="drawBaseline()" class="hover:text-blue-400">2. Baseline</button>
            <button onclick="showPage('eval')" class="hover:text-blue-400">3. Evaluation</button>
            <button onclick="drawProgressChart()" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500 text-white shadow-lg">4. Progress View</button>
        </div>
    </nav>

    <div id="setup" class="page active-page max-w-6xl mx-auto mt-8 bg-white p-8 rounded-3xl shadow-xl border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-6">
            <div class="flex-1 w-full">
                <label class="text-[10px] font-black text-slate-400 uppercase">Project Title</label>
                <input type="text" id="projName" oninput="updateNavTitle()" class="text-3xl font-black outline-none w-full border-b-2 border-slate-100 focus:border-blue-500 pb-2 transition-all" placeholder="PROJECT NAME">
            </div>
            <div class="flex gap-2 flex-wrap justify-end">
                <button onclick="exportToCSV()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold border hover:bg-slate-200 transition">Export CSV</button>
                <button onclick="document.getElementById('importFile').click()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold border hover:bg-slate-200 transition">Import CSV</button>
                <button onclick="clearAllData()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-xs font-bold border border-red-100 hover:bg-red-100 transition">Clear All</button>
                <input type="file" id="importFile" class="hidden" accept=".csv" onchange="importFromCSV(this)">
            </div>
        </div>
        
        <div id="tasks-container" class="space-y-2 mb-8">
            <div class="hidden md:grid grid-cols-12 gap-3 px-4 text-[10px] font-black text-slate-400 uppercase mb-4">
                <div class="col-span-4">Task Name</div>
                <div class="col-span-3 text-center">Start Date</div>
                <div class="col-span-1 text-center">Dur</div>
                <div class="col-span-2 text-center">Unit</div>
                <div class="col-span-2 text-center text-blue-600">Plan End</div>
            </div>
        </div>

        <div class="flex gap-4 border-t pt-8">
            <button onclick="addTaskRow()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-bold hover:scale-105 transition shadow-lg">+ Add Task</button>
            <button onclick="drawBaseline()" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold shadow-xl hover:bg-blue-700 transition">Generate Charts â†’</button>
        </div>
    </div>

    <div id="baseline" class="page max-w-7xl mx-auto mt-8 text-center px-4">
        <div class="bg-white p-10 rounded-3xl shadow-2xl border border-slate-200 text-left">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-xs font-black text-blue-500 uppercase tracking-widest">Master Plan</h2>
                    <h1 id="baseline-title-disp" class="text-3xl font-black text-slate-900 uppercase">Project Plan</h1>
                </div>
                <button onclick="downloadPNG('mermaid-baseline')" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-emerald-700 shadow-lg">Download PNG</button>
            </div>
            <div id="mermaid-baseline" class="flex justify-center bg-white p-4 rounded-xl min-h-[300px]"></div>
        </div>
    </div>

    <div id="eval" class="page max-w-4xl mx-auto mt-8 mb-20 px-4">
        <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-black text-slate-900">PROGRESS EVALUATION</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Drag sliders to update status</p>
                </div>
                <div class="bg-slate-900 text-white px-4 py-2 rounded-xl font-mono text-sm border-r-4 border-blue-500" id="current-date-display"></div>
            </div>
            <div id="eval-container" class="space-y-4"></div>
            <button onclick="drawProgressChart()" class="w-full mt-8 bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:bg-blue-700 transition">Update Status Chart</button>
        </div>
    </div>

    <div id="progress" class="page max-w-7xl mx-auto mt-8 text-center mb-20 px-4">
        <div class="bg-white p-10 rounded-3xl shadow-2xl border-t-[16px] border-slate-900 text-left">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-xs font-black text-emerald-500 uppercase tracking-widest">Tracking Report</h2>
                    <h1 id="progress-title-disp" class="text-3xl font-black text-slate-900 uppercase italic">Project Progress</h1>
                </div>
                <button onclick="downloadPNG('mermaid-progress')" class="bg-black text-white px-6 py-2 rounded-xl font-bold shadow-lg">Download Report PNG</button>
            </div>
            <div id="mermaid-progress" class="flex justify-center min-h-[300px]"></div>
            <div id="proj-stats" class="mt-12 grid grid-cols-2 md:grid-cols-4 gap-4 p-8 bg-slate-50 rounded-3xl border border-slate-200"></div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: false, theme: 'base', 
            gantt: { axisFormat: '%Y-%m-%d', barHeight: 70, fontSize: 24, sectionFontSize: 24, titleFontSize: 30 },
            themeVariables: { primaryColor: '#3b82f6', taskTextColor: '#000000', labelColor: '#000000' }
        });

        let projectTasks = [];
        const todayStr = new Date().toISOString().split('T')[0];

        function updateNavTitle() { document.getElementById('nav-title').innerText = document.getElementById('projName').value || "Project Control"; }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            if(id === 'eval') {
                document.getElementById('current-date-display').innerText = "DATE: " + todayStr;
                renderEvaluation();
            }
        }

        function clearAllData() {
            if(confirm("Are you sure? This will delete all tasks and progress.")) {
                document.getElementById('tasks-container').innerHTML = '';
                document.getElementById('projName').value = '';
                projectTasks = [];
                updateNavTitle();
                addTaskRow();
            }
        }

        function calculateEnd(s, d, u) {
            if(!s || !d) return null;
            let dt = new Date(s + "T00:00:00");
            let add = u === 'Weeks' ? d * 7 : (u === 'Months' ? d * 30 : d);
            dt.setDate(dt.getDate() + parseInt(add));
            return dt.toISOString().split('T')[0];
        }

        function addTaskRow(t = {n:'', s:'', d:1, u:'Days', p:0}) {
            const container = document.getElementById('tasks-container');
            const div = document.createElement('div');
            div.className = "task-row grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-slate-50 rounded-2xl border border-slate-100 items-center mb-2";
            div.innerHTML = `
                <input type="text" placeholder="Task Description" value="${t.n}" class="t-n col-span-4 p-2 bg-transparent font-bold outline-none border-b border-transparent focus:border-blue-500">
                <input type="date" value="${t.s}" onchange="updateRow(this)" class="t-s col-span-3 p-2 rounded-xl border text-sm">
                <input type="number" value="${t.d}" oninput="updateRow(this)" class="t-d col-span-1 p-2 bg-transparent text-center font-bold outline-none">
                <select onchange="updateRow(this)" class="t-u col-span-2 p-2 bg-transparent font-bold text-xs outline-none">
                    <option ${t.u=='Days'?'selected':''}>Days</option>
                    <option ${t.u=='Weeks'?'selected':''}>Weeks</option>
                    <option ${t.u=='Months'?'selected':''}>Months</option>
                </select>
                <div class="t-e-disp col-span-2 text-center text-[11px] font-black text-blue-600">---</div>
            `;
            container.appendChild(div);
            updateRow(div.querySelector('input'));
        }

        function updateRow(el) {
            const row = el.closest('.task-row');
            const end = calculateEnd(row.querySelector('.t-s').value, row.querySelector('.t-d').value, row.querySelector('.t-u').value);
            row.querySelector('.t-e-disp').innerText = end || "---";
            syncTasks();
        }

        function syncTasks() {
            projectTasks = Array.from(document.querySelectorAll('.task-row')).map((r, i) => ({
                n: r.querySelector('.t-n').value.replace(/[:()]/g, ''), 
                s: r.querySelector('.t-s').value,
                d: r.querySelector('.t-d').value,
                u: r.querySelector('.t-u').value,
                p: projectTasks[i]?.p || 0
            }));
        }

        function exportToCSV() {
            let csv = "Name,Start,Duration,Unit,Progress\n";
            projectTasks.forEach(t => csv += `"${t.n}","${t.s}","${t.d}","${t.u}","${t.p}"\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${document.getElementById('projName').value || 'Project'}_Data.csv`;
            a.click();
        }

        function importFromCSV(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n').slice(1);
                document.getElementById('tasks-container').innerHTML = '';
                projectTasks = [];
                lines.forEach(l => {
                    const c = l.split(',').map(v => v.replace(/"/g, ''));
                    if(c.length >= 4) addTaskRow({n:c[0], s:c[1], d:c[2], u:c[3], p:c[4]||0});
                });
            };
            reader.readAsText(input.files[0]);
        }

        async function drawBaseline() {
            showPage('baseline');
            const pName = document.getElementById('projName').value || "PROJECT PLAN";
            document.getElementById('baseline-title-disp').innerText = pName;
            const target = document.getElementById('mermaid-baseline');
            target.innerHTML = "Rendering...";
            
            let code = `gantt\n  title ${pName}\n  dateFormat YYYY-MM-DD\n  axisFormat %m-%d\n  section Master Plan\n`;
            projectTasks.forEach((t, i) => {
                if(!t.s || !t.d) return;
                const end = calculateEnd(t.s, t.d, t.u);
                code += `  ${t.n} [ ${t.s} | ${end} ] :active, T${i}, ${t.s}, ${t.d}${t.u[0].toLowerCase()}\n`;
            });
            const { svg } = await mermaid.render('b-chart', code);
            target.innerHTML = svg;
        }

        async function drawProgressChart() {
            showPage('progress');
            const pName = document.getElementById('projName').value || "PROJECT PROGRESS";
            document.getElementById('progress-title-disp').innerText = pName;
            const target = document.getElementById('mermaid-progress');
            target.innerHTML = "Rendering...";
            let code = `gantt\n  title ${pName} STATUS\n  dateFormat YYYY-MM-DD\n  axisFormat %m-%d\n  section Status\n`;
            let minS = null; let maxE = null;
            projectTasks.forEach((t, i) => {
                if(!t.s || !t.d) return;
                const totalDays = t.u === 'Weeks' ? t.d * 7 : (t.u === 'Months' ? t.d * 30 : t.d);
                const doneDays = (totalDays * (t.p / 100)).toFixed(1);
                const remDays = (totalDays - doneDays).toFixed(1);
                const end = calculateEnd(t.s, t.d, t.u);
                if(!minS || t.s < minS) minS = t.s;
                if(!maxE || end > maxE) maxE = end;
                if (t.p == 100) code += `  ${t.n} (100% COMPLETE) :done, P${i}_f, ${t.s}, ${t.d}${t.u[0].toLowerCase()}\n`;
                else if (t.p == 0) code += `  ${t.n} (0% STARTING ${t.s}) :active, P${i}_e, ${t.s}, ${t.d}${t.u[0].toLowerCase()}\n`;
                else {
                    code += `  ${t.n} (${t.p}%) :done, P${i}_d, ${t.s}, ${doneDays}d\n`;
                    code += `  Remaining [DUE ${end}] :active, P${i}_a, after P${i}_d, ${remDays}d\n`;
                }
            });
            const { svg } = await mermaid.render('p-chart', code);
            target.innerHTML = svg;
            updateStats(minS, maxE);
        }

        function updateStats(s, e) {
            document.getElementById('proj-stats').innerHTML = `
                <div class="text-left"><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Global Start</p><p class="text-lg font-bold text-blue-600">${s || '---'}</p></div>
                <div class="text-left"><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Global Finish</p><p class="text-lg font-bold text-emerald-600">${e || '---'}</p></div>
                <div class="text-left"><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Updated On</p><p class="text-lg font-bold text-slate-900">${todayStr}</p></div>
                <div class="text-left"><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Lead Owner</p><p class="text-lg font-bold text-slate-900">Ali Bazrafkan</p></div>
            `;
        }

        function renderEvaluation() {
            const container = document.getElementById('eval-container'); container.innerHTML = '';
            projectTasks.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = `p-6 rounded-3xl border-2 transition-all ${t.p == 100 ? 'bg-slate-900 text-white border-blue-500' : 'bg-white border-slate-100 hover:shadow-lg'}`;
                div.innerHTML = `
                    <div class="flex justify-between mb-3 font-bold uppercase text-xs"><span>${t.n}</span><span class="text-blue-500">${t.p}%</span></div>
                    <input type="range" value="${t.p}" min="0" max="100" class="w-full h-3 bg-slate-200 rounded-xl appearance-none cursor-pointer accent-blue-600" onchange="updateProg(${i}, this.value)">
                `;
                container.appendChild(div);
            });
        }

        function updateProg(i, v) { projectTasks[i].p = v; renderEvaluation(); }

        function downloadPNG(containerId) {
            const svg = document.querySelector(`#${containerId} svg`);
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement("canvas");
            const rect = svg.getBoundingClientRect();
            const scale = 3; 
            canvas.width = rect.width * scale; canvas.height = rect.height * scale;
            const ctx = canvas.getContext("2d");
            const img = new Image();
            img.onload = () => {
                ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const a = document.createElement("a");
                a.download = `${document.getElementById('projName').value || 'Gantt'}_Report.png`;
                a.href = canvas.toDataURL("image/png");
                a.click();
            };
            img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
        }

        // Initialize with one empty row
        addTaskRow();
    </script>
</body>
</html>